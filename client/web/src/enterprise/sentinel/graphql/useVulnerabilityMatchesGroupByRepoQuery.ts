import { dataOrThrowErrors } from '@sourcegraph/http-client'

import {
    UseShowMorePaginationResult,
    useShowMorePagination,
} from '../../../components/FilteredConnection/hooks/useShowMorePagination'
import {
    VulnerabilityMatchesGroupedByRepositoryResult,
    VulnerabilityMatchesGroupedByRepositoryVariables,
    VulnerabilityMatchesGroupedByRepositoryFields,
} from '../../../graphql-operations'

import { VULNERABILITY_MATCHES_GROUPED_BY_REPOSITORY } from './graphqlQueries'

interface UseVulnerabilityMatchesGroupByRepoProps {
    repositoryName: string
}

export const useVulnerabilityMatchesGroupByRepoQuery = ({
    repositoryName,
}: UseVulnerabilityMatchesGroupByRepoProps): UseShowMorePaginationResult<
    VulnerabilityMatchesGroupedByRepositoryResult,
    VulnerabilityMatchesGroupedByRepositoryFields
> => {
    return useShowMorePagination<
        VulnerabilityMatchesGroupedByRepositoryResult,
        VulnerabilityMatchesGroupedByRepositoryVariables,
        VulnerabilityMatchesGroupedByRepositoryFields
    >({
        query: VULNERABILITY_MATCHES_GROUPED_BY_REPOSITORY,
        variables: { after: null, first: 50, repositoryName },
        options: { fetchPolicy: 'network-only' },
        getConnection: result => {
            const { vulnerabilityMatchesGroupByRepository } = dataOrThrowErrors(result)
            return vulnerabilityMatchesGroupByRepository
        },
    })
}
